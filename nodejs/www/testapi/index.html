<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API</title>
</head>

<body>
    <h1>API Fetch Test</h1>

    <div id="status-message"></div>

    <script>
        // Paste the full JavaScript code I provided here...
        async function fetchData() {
            // Clear previous messages on new attempt
            const statusContainer = document.getElementById('status-message');
            if (statusContainer) {
                statusContainer.innerHTML = '';
            }

            try {
                const response = await fetch('https://landsmaps.dol.go.th/apiService/JWT/GetJWTAccessToken');

                const responseText = await response.text();

                if (responseText.includes("Incapsula incident ID")) {
                    handleIncapsulaChallenge("https://landsmaps.dol.go.th/apiService/JWT/GetJWTAccessToken");
                    return;
                }

                const jsonData = JSON.parse(responseText);
                console.log("Success! Received JSON data:", jsonData);
                if (statusContainer) {
                    statusContainer.innerText = 'Success! Check the console for data.';
                }

            } catch (error) {
                console.error("Error during fetch:", error);
                // This line was causing an error because 'statusContainer' was null
                if (statusContainer) {
                    statusContainer.innerText = 'An error occurred. Please check the console.';
                }
            }
        }

        async function handleIncapsulaChallenge(urlToOpen) {
            try {
                const container = document.getElementById('status-message');
                // This line was causing an error because 'container' was null
                if (container) {
                    container.innerHTML = `
                    <p>A security check is required to continue.</p>
                    <p>Please complete the check in the new tab, then close it and click 'Retry'.</p>
                    <button id="open-challenge-btn">Open Security Check</button>
                    <button onclick="fetchData()">Retry</button>
                `;

                    const response = await fetch('https://landsmaps.dol.go.th/apiService/JWT/GetJWTAccessToken');
                    const responseText = await response.json();
                    console.log(responseText.result[0].access_token);

                    document.getElementById('open-challenge-btn').onclick = () => {
                        window.open(urlToOpen, '_blank');
                    };
                }
            } catch (error) {
                console.error("Error handling Incapsula challenge:", error);

            }

        }

        // It's best practice to wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });
    </script>
</body>

</html>